name: Continuous Integration

on:
  push:
  workflow_dispatch:

jobs:
  execute_test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Use Python 3.9
        uses: actions/setup-python@v5
        with:
          python-version: 3.9
          cache: 'pip'

      - name: Install Dependencies
        run: |
          pip install -r requirements.txt

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          components: |
            platform-tools
            build-tools;34.0.0
            platforms;android-34
            system-images;android-34;google_apis;x86_64
            emulator

      - name: Set ANDROID_HOME and Emulator Path
        run: |
          echo "Setting ANDROID_HOME and emulator path"
          export ANDROID_SDK_ROOT=/usr/local/lib/android/sdk
          export PATH=$ANDROID_SDK_ROOT/emulator:$ANDROID_SDK_ROOT/tools:$ANDROID_SDK_ROOT/tools/bin:$ANDROID_SDK_ROOT/platform-tools:$PATH
          sdkmanager --list --add-modules java.se.ee  # Adiciona o JAXB ao Java

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 'lts/*'

      - name: Install Appium
        run: |
          npm install -g appium

      - name: Ensure UiAutomator2 Driver is Installed
        run: |
          if ! appium driver list --installed | grep uiautomator2; then
            appium driver install uiautomator2 || true;
          else
            appium driver update uiautomator2 || true;
          fi

      - name: Start Appium
        run: |
          nohup appium -p 4725 --log-level debug &
          sleep 10

      - name: Check Appium server
        run: |
          curl http://localhost:4725/sessions || exit 1

      - name: Run Robot Framework Tests
        run: |
          robot -d ./reports -v APPIUM_PORT:4725 .

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: reports
          path: reports
